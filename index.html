<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>T√≠nh ƒêi·ªÉm H·ªçc B·∫° & ∆Øu Ti√™n</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media (prefers-reduced-motion: reduce){*{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important}}
    .glass{background:rgba(255,255,255,.05);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1)}
    .input-glass{background:rgba(255,255,255,.08);backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.2)}
    .tooltip{position:relative}
    .tooltip:hover::after{content:attr(data-tooltip);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.9);color:#fff;padding:8px 12px;border-radius:6px;font-size:12px;white-space:nowrap;z-index:1000;margin-bottom:5px}
    .tooltip:hover::before{content:'';position:absolute;bottom:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:rgba(0,0,0,.9);margin-bottom:-5px}
    select{color-scheme:dark;-webkit-appearance:none;-moz-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' stroke='white' viewBox='0 0 24 24' fill='none' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right 12px center;background-size:16px;padding-right:40px}
    select option{background:#1e1e2f!important;color:#fff!important}
    select option:hover,select option:focus,select option:checked{background:#3b82f6!important;color:#fff!important}
    select::-ms-expand{display:none}
    select:-moz-focusring{color:transparent;text-shadow:0 0 0 #fff}
    .callout{background:linear-gradient(135deg,rgba(59,130,246,.1),rgba(147,51,234,.1));border:1px solid rgba(59,130,246,.3);border-radius:12px;padding:16px;position:relative;backdrop-filter:blur(10px);transition:all .3s ease}
    .callout:hover{border-color:rgba(59,130,246,.5);transform:translateY(-2px);box-shadow:0 8px 25px rgba(59,130,246,.15)}
    .callout-close{position:absolute;top:8px;right:8px;background:rgba(255,255,255,.1);border:none;color:#94a3b8;font-size:18px;width:24px;height:24px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s ease}
    .callout-close:hover{background:rgba(255,255,255,.2);color:#f1f5f9}
    /* mobile tightening */
    @media (max-width:640px){
      .tight-grid{gap:12px}
      .tight-stack > * + *{margin-top:8px}
      .tight-input{padding:.65rem .8rem}
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-950 via-indigo-950 to-fuchsia-950 min-h-screen text-white">
  <div class="container mx-auto px-4 py-6 max-w-7xl">
    <header class="text-center mb-6">
      <h1 class="text-3xl md:text-4xl font-extrabold mb-1 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
        T√≠nh ƒêi·ªÉm H·ªçc B·∫° & ∆Øu Ti√™n
      </h1>
      <p class="text-gray-300 text-sm md:text-base">C√¥ng c·ª• gi√∫p b·∫°n qu·∫£n l√Ω d·ªÖ d√†ng h∆°n ƒëi·ªÉm s·ªë.</p>
    </header>

    <!-- Callout countdown -->
    <div id="countdown-callout" class="callout mb-5">
      <div class="flex items-center gap-3">
        <div class="text-2xl">‚è≥</div>
        <div class="flex-1">
          <div class="font-semibold text-slate-200">Khi n√†o ƒë·∫øn k·ª≥ thi THPTQG?</div>
          <a class="underline text-blue-300 hover:text-blue-200" target="_blank" href="https://rroyal1504.github.io/thptqg-countdown/">‚Üí Click v√†o!</a>
          <span class="ml-2 text-[10px] px-2 py-[2px] rounded bg-gradient-to-r from-rose-500 to-amber-500">m·ªõi</span>
        </div>
      </div>
      <button class="callout-close" onclick="closeCallout('countdown')">&times;</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
      <!-- Form ƒëi·ªÉm -->
      <div class="lg:col-span-2">
        <div class="glass rounded-xl p-5 mb-5">
          <h2 class="text-lg font-semibold mb-3">üìö Nh·∫≠p ƒêi·ªÉm 3 M√¥n</h2>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 tight-grid">
            <!-- M√¥n 1 -->
            <div>
              <h3 class="font-medium text-blue-300 mb-2">M√¥n 1</h3>
              <div class="space-y-2 tight-stack">
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-300 w-14">L·ªõp 10</span>
                  <input type="number" id="m1-l10" min="0" max="10" step="0.1" placeholder="ƒëi·ªÉm"
                    class="w-full p-3 tight-input rounded-lg input-glass text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-300 w-14">L·ªõp 11</span>
                  <input type="number" id="m1-l11" min="0" max="10" step="0.1" placeholder="ƒëi·ªÉm"
                    class="w-full p-3 tight-input rounded-lg input-glass text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-300 w-14">L·ªõp 12</span>
                  <input type="number" id="m1-l12" min="0" max="10" step="0.1" placeholder="ƒëi·ªÉm"
                    class="w-full p-3 tight-input rounded-lg input-glass text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="text-sm text-gray-300">TB: <span id="avg-m1" class="font-semibold text-blue-300">0.00</span></div>
              </div>
            </div>

            <!-- M√¥n 2 -->
            <div>
              <h3 class="font-medium text-green-300 mb-2">M√¥n 2</h3>
              <div class="space-y-2 tight-stack">
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-300 w-14">L·ªõp 10</span>
                  <input type="number" id="m2-l10" min="0" max="10" step="0.1" placeholder="ƒëi·ªÉm"
                    class="w-full p-3 tight-input rounded-lg input-glass text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-300 w-14">L·ªõp 11</span>
                  <input type="number" id="m2-l11" min="0" max="10" step="0.1" placeholder="ƒëi·ªÉm"
                    class="w-full p-3 tight-input rounded-lg input-glass text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-300 w-14">L·ªõp 12</span>
                  <input type="number" id="m2-l12" min="0" max="10" step="0.1" placeholder="ƒëi·ªÉm"
                    class="w-full p-3 tight-input rounded-lg input-glass text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div class="text-sm text-gray-300">TB: <span id="avg-m2" class="font-semibold text-green-300">0.00</span></div>
              </div>
            </div>

            <!-- M√¥n 3 -->
            <div>
              <h3 class="font-medium text-purple-300 mb-2">M√¥n 3</h3>
              <div class="space-y-2 tight-stack">
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-300 w-14">L·ªõp 10</span>
                  <input type="number" id="m3-l10" min="0" max="10" step="0.1" placeholder="ƒëi·ªÉm"
                    class="w-full p-3 tight-input rounded-lg input-glass text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-300 w-14">L·ªõp 11</span>
                  <input type="number" id="m3-l11" min="0" max="10" step="0.1" placeholder="ƒëi·ªÉm"
                    class="w-full p-3 tight-input rounded-lg input-glass text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-300 w-14">L·ªõp 12</span>
                  <input type="number" id="m3-l12" min="0" max="10" step="0.1" placeholder="ƒëi·ªÉm"
                    class="w-full p-3 tight-input rounded-lg input-glass text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="text-sm text-gray-300">TB: <span id="avg-m3" class="font-semibold text-purple-300">0.00</span></div>
              </div>
            </div>
          </div>
        </div>

        <!-- ∆Øu ti√™n -->
        <div class="glass rounded-xl p-5 mb-5">
          <h2 class="text-lg font-semibold mb-3 flex items-center">
            ‚öôÔ∏è C√°ch t√≠nh ƒêi·ªÉm ∆Øu Ti√™n
            <span class="tooltip ml-2 cursor-help text-blue-400" data-tooltip="Chu·∫©n B·ªô: T<22.5 ‚áí c·ªông ƒë·ªß; t·ª´ 22.5‚Üí30 gi·∫£m tuy·∫øn t√≠nh. CUSTOM: ng∆∞·ª°ng & m·∫´u s·ªë t·ª± ch·ªçn.">‚ìò</span>
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm mb-1">Ch·∫ø ƒë·ªô ∆∞u ti√™n</label>
              <select id="priority-mode" class="w-full p-3 rounded-lg input-glass text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="MOET">Chu·∫©n B·ªô (22.5 ‚Üí 30)</option>
                <option value="CUSTOM">T√πy bi·∫øn</option>
              </select>
            </div>

            <div id="custom-options" class="hidden grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm mb-1">Ng∆∞·ª°ng</label>
                <input id="custom-threshold" type="number" value="28" min="0" max="30" step="0.1"
                       class="w-full p-2 rounded-lg input-glass text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-sm mb-1">M·∫´u s·ªë</label>
                <input id="custom-denom" type="number" value="2" min="0.1" step="0.1"
                       class="w-full p-2 rounded-lg input-glass text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>

            <div>
              <label class="block text-sm mb-1">Khu v·ª±c</label>
              <select id="area-bonus" class="w-full p-3 rounded-lg input-glass text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="0.75" selected>KV1 (0.75)</option>
                <option value="0.5">KV2-NT (0.50)</option>
                <option value="0.25">KV2 (0.25)</option>
                <option value="0">KV3 (0.00)</option>
              </select>
            </div>

            <div>
              <label class="block text-sm mb-1">ƒêi·ªÉm ƒë·ªëi t∆∞·ª£ng</label>
              <input id="category-bonus" type="number" value="0" min="0" max="1" step="0.01"
                class="w-full p-3 rounded-lg input-glass text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.00">
            </div>
          </div>
        </div>
      </div>

      <!-- Th√†nh t√≠ch -->
      <div class="glass rounded-xl p-5">
        <h2 class="text-lg font-semibold mb-3">üèÜ Th√†nh T√≠ch</h2>
        <div class="space-y-2 max-h-96 overflow-y-auto" id="achievements-list"></div>
        <div class="mt-4 pt-4 border-t border-white/10">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="allow-multiple" class="rounded">
            <span class="text-sm">Cho ph√©p c·ªông d·ªìn nhi·ªÅu th√†nh t√≠ch</span>
          </label>
        </div>
      </div>
    </div>

    <!-- K·∫øt qu·∫£ -->
    <div class="glass rounded-xl p-5 mt-5">
      <h2 class="text-lg font-semibold mb-3">üìä K·∫øt Qu·∫£</h2>
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-3" aria-live="polite">
        <div class="bg-blue-500/20 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-blue-300" id="total-30">0.00</div>
          <div class="text-xs text-gray-300 mt-1">T·ªïng h·ªçc b·∫° (30)</div>
        </div>
        <div class="bg-green-500/20 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-green-300" id="base-bonus">0.00</div>
          <div class="text-xs text-gray-300 mt-1">∆Øu ti√™n c∆° s·ªü</div>
        </div>
        <div class="bg-purple-500/20 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-purple-300" id="final-bonus">0.00</div>
          <div class="text-xs text-gray-300 mt-1">∆Øu ti√™n sau gi·∫£m</div>
        </div>
        <div class="bg-yellow-500/20 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold text-yellow-300" id="final-total">0.00</div>
          <div class="text-xs text-gray-300 mt-1">T·ªïng cu·ªëi c√πng</div>
        </div>
      </div>

      <div class="mt-5 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
        <div class="space-y-1">
          <div class="font-medium text-blue-300">Chi ti·∫øt ∆∞u ti√™n c∆° s·ªü</div>
          <div>Khu v·ª±c: <span id="detail-area">0.00</span></div>
          <div>ƒê·ªëi t∆∞·ª£ng: <span id="detail-category">0.00</span></div>
          <div>Th√†nh t√≠ch: <span id="detail-achievement">0.00</span></div>
        </div>
        <div class="space-y-1">
          <div class="font-medium text-green-300">C√¥ng th·ª©c √°p d·ª•ng</div>
          <div id="formula-display" class="text-gray-300">Chu·∫©n B·ªô: (30‚àíT·ªïng)/7.5 √ó ∆Øu ti√™n c∆° s·ªü (T‚â•22.5)</div>
        </div>
        <div class="space-y-2">
          <button id="reset-btn" class="w-full bg-red-500/20 hover:bg-red-500/30 text-red-300 py-2 px-4 rounded-lg">üîÑ Reset</button>
          <button id="copy-btn" class="w-full bg-blue-500/20 hover:bg-blue-500/30 text-blue-300 py-2 px-4 rounded-lg">üìã Copy k·∫øt qu·∫£</button>
        </div>
      </div>
    </div>

    <!-- ∆Ø·ªõc l∆∞·ª£ng -->
    <div class="glass rounded-xl p-5 mt-5">
      <h2 class="text-lg font-semibold mb-3">üéØ ∆Ø·ªõc L∆∞·ª£ng ƒêi·ªÉm</h2>
      <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-3 mb-4 text-sm text-blue-300">
        üí° Nh·∫≠p ƒëi·ªÉm b·∫°n ƒë√£ c√≥. N·∫øu ƒëi·ªÉm thi·∫øu, m·∫∑c ƒë·ªãnh s·∫Ω ∆∞·ªõc l∆∞·ª£ng cho <b>L·ªõp 12</b>.
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm mb-1">Lo·∫°i m·ª•c ti√™u</label>
              <select id="target-type" class="w-full p-3 rounded-lg input-glass text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="academic">H·ªçc b·∫° thu·∫ßn (30)</option>
                <option value="total">T·ªïng cu·ªëi (c√≥ ∆∞u ti√™n)</option>
              </select>
            </div>
            <div>
              <label class="block text-sm mb-1">M·ª•c ti√™u (G)</label>
              <input id="target-score" type="number" value="24" min="0" max="30" step="0.01"
                     class="w-full p-3 rounded-lg input-glass text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
          </div>

          <div>
            <label class="block text-sm mb-1">Chi·∫øn l∆∞·ª£c ph√¢n b·ªï</label>
            <select id="strategy" class="w-full p-3 rounded-lg input-glass text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="even">Chia ƒë·ªÅu</option>
              <option value="history">Theo nƒÉng l·ª±c qu√° kh·ª©</option>
              <option value="minimax">Minimax (gi·ªõi h·∫°n l·ªách l·ªõn nh·∫•t)</option>
            </select>

            <div class="mt-3 p-3 bg-white/5 rounded text-xs space-y-2" id="strategy-explanation">
              <div id="even-explanation"><span class="text-blue-300 font-medium">üìä Chia ƒë·ªÅu:</span> Chia ƒë·ªÅu ƒëi·ªÉm c√°c m√¥n c·ªßa b·∫°n.</div>
              <div id="history-explanation" class="hidden"><span class="text-green-300 font-medium">üìà Theo nƒÉng l·ª±c qu√° kh·ª©:</span> ∆Øu ti√™n h∆°n c√°c m√¥n s·ªü tr∆∞·ªùng c·ªßa b·∫°n.</div>
              <div id="minimax-explanation" class="hidden"><span class="text-purple-300 font-medium">‚öñÔ∏è Minimax ‚àû-norm:</span> H·∫°n ch·∫ø l·ªách t·ªëi ƒëa so v·ªõi baseline (TB 10‚Äì11 / 8.0) ‚Äî gi√∫p v·ª´a s·ª©c m·ªói ng∆∞·ªùi.</div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm mb-1">ƒêi·ªÉm t·ªëi thi·ªÉu</label>
              <input id="min-score" type="number" value="0" min="0" max="10" step="0.1"
                     class="w-full p-3 rounded-lg input-glass text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm mb-1">ƒêi·ªÉm t·ªëi ƒëa</label>
              <input id="max-score" type="number" value="10" min="0" max="10" step="0.1"
                     class="w-full p-3 rounded-lg input-glass text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
          </div>

          <button id="estimate-btn" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 py-3 rounded-lg font-medium">
            üîÆ T√≠nh ∆Ø·ªõc L∆∞·ª£ng
          </button>
        </div>

        <div class="space-y-4">
          <div id="estimation-result" class="hidden">
            <div class="bg-green-500/20 rounded-lg p-4 mb-3 text-center">
              <div class="text-lg font-semibold text-green-300" id="est-status">ƒê·∫°t m·ª•c ti√™u</div>
              <div class="text-sm text-gray-300 mt-1">
                H·ªçc b·∫°: <span id="est-academic">0.00</span> |
                ∆Øu ti√™n: <span id="est-priority">0.00</span> |
                T·ªïng: <span id="est-total">0.00</span>
              </div>
            </div>
            <div id="estimation-table" class="space-y-2"></div>
            <button id="apply-estimation" class="w-full bg-green-500/20 hover:bg-green-500/30 text-green-300 py-2 rounded-lg">‚úÖ √Åp D·ª•ng K·∫øt Qu·∫£</button>
          </div>

          <div id="estimation-error" class="hidden bg-red-500/20 rounded-lg p-4">
            <div class="text-red-300 font-medium">Kh√¥ng kh·∫£ thi!</div>
            <div class="text-sm text-gray-300 mt-1" id="error-message">M·ª•c ti√™u t·ªëi ƒëa c√≥ th·ªÉ ƒë·∫°t: <span id="max-achievable">0.00</span></div>
          </div>
        </div>
      </div>
    </div>

    <footer class="text-center mt-8 text-gray-400 text-sm">
      <p>¬© 2025 ¬∑ Made by rRoyal</p>
    </footer>
  </div>

  <script>
    const ACHIEVEMENTS = [
      { id:'hsg-quoc-gia-123', label:'HSG Qu·ªëc gia/qu·ªëc t·∫ø (nh·∫•t/nh√¨/ba)', base:2.00 },
      { id:'khkt-quoc-gia-123', label:'KHKT qu·ªëc gia (nh·∫•t/nh√¨/ba) c√πng ng√†nh', base:2.00 },
      { id:'hsg-quoc-gia-kk', label:'HSG qu·ªëc gia/qu·ªëc t·∫ø (KK)', base:1.75 },
      { id:'khkt-quoc-gia-4', label:'KHKT qu·ªëc gia (gi·∫£i t∆∞) c√πng ng√†nh', base:1.75 },
      { id:'hsg-tinh-12', label:'HSG c·∫•p t·ªânh/th√†nh (nh·∫•t/nh√¨)', base:1.50 },
      { id:'hsg-tinh-3', label:'HSG c·∫•p t·ªânh/th√†nh (ba)', base:1.00 },
      { id:'khkt-tinh-12', label:'KHKT c·∫•p t·ªânh/th√†nh (nh·∫•t/nh√¨) c√πng ng√†nh', base:1.50 },
      { id:'khkt-tinh-3', label:'KHKT c·∫•p t·ªânh/th√†nh (ba) c√πng ng√†nh', base:1.00 },
      { id:'icpc-thpt-12', label:'ICPC THPT (v√¥ ƒë·ªãch/nh·∫•t/nh√¨)', base:2.00 },
      { id:'icpc-thpt-3kk', label:'ICPC THPT (ba/KK)', base:1.75 },
      { id:'olympic-304-vb', label:'Olympic 30/4 (V√†ng/B·∫°c)', base:1.50 },
      { id:'olympic-304-d', label:'Olympic 30/4 (ƒê·ªìng)', base:1.00 }
    ];

    const elements = {
      m1: ['m1-l10','m1-l11','m1-l12'].map(id=>document.getElementById(id)),
      m2: ['m2-l10','m2-l11','m2-l12'].map(id=>document.getElementById(id)),
      m3: ['m3-l10','m3-l11','m3-l12'].map(id=>document.getElementById(id)),
      avgM1: document.getElementById('avg-m1'),
      avgM2: document.getElementById('avg-m2'),
      avgM3: document.getElementById('avg-m3'),

      priorityMode: document.getElementById('priority-mode'),
      customOptions: document.getElementById('custom-options'),
      customThreshold: document.getElementById('custom-threshold'),
      customDenom: document.getElementById('custom-denom'),
      areaBonus: document.getElementById('area-bonus'),
      categoryBonus: document.getElementById('category-bonus'),
      allowMultiple: document.getElementById('allow-multiple'),

      total30: document.getElementById('total-30'),
      baseBonus: document.getElementById('base-bonus'),
      finalBonus: document.getElementById('final-bonus'),
      finalTotal: document.getElementById('final-total'),
      detailArea: document.getElementById('detail-area'),
      detailCategory: document.getElementById('detail-category'),
      detailAchievement: document.getElementById('detail-achievement'),
      formulaDisplay: document.getElementById('formula-display'),

      achievementsList: document.getElementById('achievements-list'),
      resetBtn: document.getElementById('reset-btn'),
      copyBtn: document.getElementById('copy-btn'),

      targetType: document.getElementById('target-type'),
      targetScore: document.getElementById('target-score'),
      strategy: document.getElementById('strategy'),
      minScore: document.getElementById('min-score'),
      maxScore: document.getElementById('max-score'),
      estimateBtn: document.getElementById('estimate-btn'),
      estimationResult: document.getElementById('estimation-result'),
      estimationError: document.getElementById('estimation-error'),
      estStatus: document.getElementById('est-status'),
      estAcademic: document.getElementById('est-academic'),
      estPriority: document.getElementById('est-priority'),
      estTotal: document.getElementById('est-total'),
      estimationTable: document.getElementById('estimation-table'),
      applyEstimation: document.getElementById('apply-estimation'),
      errorMessage: document.getElementById('error-message'),
      maxAchievable: document.getElementById('max-achievable')
    };

    function round2(x){return Math.round((x+Number.EPSILON)*100)/100}
    function avg3(a,b,c){return round2((a+b+c)/3)}
    function clamp(x,lo,hi){return Math.max(lo,Math.min(hi,x))}
    function subjOf(i){return Math.floor(i/3)} // 0..2

    function calcPriority(total, baseBonus, mode, opt={}){
      const {threshold,denom} = (mode==='MOET') ? {threshold:22.5,denom:7.5} : {threshold:(opt.threshold??28),denom:(opt.denom??2)};
      if (baseBonus<=0) return 0;
      if (total<threshold) return round2(baseBonus);
      return round2(Math.max(0, ((30-total)/denom)*baseBonus));
    }

    function initAchievements(){
      elements.achievementsList.innerHTML = ACHIEVEMENTS.map(a=>(
        `<label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-white/5">
           <input type="checkbox" class="achievement-checkbox rounded" data-id="${a.id}" data-base="${a.base}">
           <span class="text-sm flex-1">${a.label}</span>
           <span class="text-xs text-gray-400">+${a.base.toFixed(2)}</span>
         </label>`
      )).join('');
    }

    function getInputs(){
      const a = elements.m1.map(i=>parseFloat(i.value)||0);
      const b = elements.m2.map(i=>parseFloat(i.value)||0);
      const c = elements.m3.map(i=>parseFloat(i.value)||0);
      return {a,b,c};
    }

    function calculate(){
      const {a,b,c}=getInputs();
      const avg1 = avg3(a[0],a[1],a[2]);
      const avg2 = avg3(b[0],b[1],b[2]);
      const avg3v= avg3(c[0],c[1],c[2]);
      elements.avgM1.textContent = avg1.toFixed(2);
      elements.avgM2.textContent = avg2.toFixed(2);
      elements.avgM3.textContent = avg3v.toFixed(2);

      const total30 = round2(avg1+avg2+avg3v);

      const area = parseFloat(elements.areaBonus.value)||0;
      const cat  = parseFloat(elements.categoryBonus.value)||0;

      const checks = document.querySelectorAll('.achievement-checkbox:checked');
      let ach=0;
      if (elements.allowMultiple.checked){
        checks.forEach(cb=>ach += parseFloat(cb.dataset.base)||0);
      } else {
        let m=0; checks.forEach(cb=>{const v=parseFloat(cb.dataset.base)||0; if (v>m) m=v;}); ach=m;
      }
      ach = round2(ach);
      const baseBonus = round2(area+cat+ach);

      const mode = elements.priorityMode.value;
      const opt = {threshold:parseFloat(elements.customThreshold.value)||28, denom:parseFloat(elements.customDenom.value)||2};
      const finalBonus = calcPriority(total30, baseBonus, mode, opt);
      const finalTotal = round2(total30 + finalBonus);

      elements.total30.textContent = total30.toFixed(2);
      elements.baseBonus.textContent = baseBonus.toFixed(2);
      elements.finalBonus.textContent = finalBonus.toFixed(2);
      elements.finalTotal.textContent = finalTotal.toFixed(2);
      elements.detailArea.textContent = area.toFixed(2);
      elements.detailCategory.textContent = cat.toFixed(2);
      elements.detailAchievement.textContent = ach.toFixed(2);
      elements.formulaDisplay.textContent = (mode==='MOET')
        ? 'Chu·∫©n B·ªô: T<22.5 ‚áí P=B; T‚â•22.5 ‚áí P=(30‚àíT)/7.5 √ó B'
        : `T√πy bi·∫øn: T<thr ‚áí P=B; T‚â•thr ‚áí P=(30‚àíT)/${opt.denom} √ó B (thr=${opt.threshold})`;

      saveState();
    }

    function saveState(){
      const state={
        m1:elements.m1.map(i=>i.value),
        m2:elements.m2.map(i=>i.value),
        m3:elements.m3.map(i=>i.value),
        priorityMode:elements.priorityMode.value,
        customThreshold:elements.customThreshold.value,
        customDenom:elements.customDenom.value,
        areaBonus:elements.areaBonus.value,
        categoryBonus:elements.categoryBonus.value,
        allowMultiple:elements.allowMultiple.checked,
        achievements:Array.from(document.querySelectorAll('.achievement-checkbox:checked')).map(cb=>cb.dataset.id)
      };
      localStorage.setItem('gradeCalculatorState', JSON.stringify(state));
    }

    function loadState(){
      const raw=localStorage.getItem('gradeCalculatorState'); if(!raw) return;
      try{
        const s=JSON.parse(raw);
        s.m1?.forEach((v,i)=>elements.m1[i]&&(elements.m1[i].value=v));
        s.m2?.forEach((v,i)=>elements.m2[i]&&(elements.m2[i].value=v));
        s.m3?.forEach((v,i)=>elements.m3[i]&&(elements.m3[i].value=v));
        if(s.priorityMode) elements.priorityMode.value=s.priorityMode;
        if(s.customThreshold) elements.customThreshold.value=s.customThreshold;
        if(s.customDenom) elements.customDenom.value=s.customDenom;
        if(s.areaBonus) elements.areaBonus.value=s.areaBonus;
        if(s.categoryBonus) elements.categoryBonus.value=s.categoryBonus;
        if(s.allowMultiple!==undefined) elements.allowMultiple.checked=s.allowMultiple;
        if(s.achievements){s.achievements.forEach(id=>{const cb=document.querySelector(`[data-id="${id}"]`); if(cb) cb.checked=true;});}
        toggleCustomOptions();
      }catch(e){}
    }

    function toggleCustomOptions(){
      const isC = elements.priorityMode.value==='CUSTOM';
      elements.customOptions.classList.toggle('hidden', !isC);
    }

    function resetForm(){
      [...elements.m1,...elements.m2,...elements.m3].forEach(i=>i.value='');
      elements.priorityMode.value='MOET';
      elements.customThreshold.value='28';
      elements.customDenom.value='2';
      elements.areaBonus.value='0.75';
      elements.categoryBonus.value='0';
      elements.allowMultiple.checked=false;
      document.querySelectorAll('.achievement-checkbox').forEach(cb=>cb.checked=false);
      localStorage.removeItem('gradeCalculatorState');
      toggleCustomOptions(); calculate();
    }

    // ======== Estimation ========
    function solveAcademicFromTotal(totalTarget, bonusConfig){
      const {baseBonus,mode,options}=bonusConfig;
      if (baseBonus<=0) return totalTarget;
      let lo=0, hi=30, tol=1e-3;
      for(let it=0; it<80; it++){
        const mid=(lo+hi)/2;
        const p=calcPriority(mid,baseBonus,mode,options);
        const f=mid+p;
        if (Math.abs(f-totalTarget)<tol) return round2(mid);
        if (f<totalTarget) lo=mid; else hi=mid;
      }
      return null;
    }

    function calculateCurrentAcademicSum(scores, unknowns){
      let s=0;
      for(let i=0;i<9;i++) if(!unknowns.includes(i)) s += scores[i]||0;
      return s;
    }

    // ====== Smart allocation core ======
    function projectToBoxSum(b, lo, hi, need){
      const n=b.length;
      const sumLo=lo.reduce((x,y)=>x+y,0);
      const sumHi=hi.reduce((x,y)=>x+y,0);
      if (need<sumLo-1e-6 || need>sumHi+1e-6) return null;
      let L=-100, R=100;
      for(let it=0; it<80; it++){
        const t=(L+R)/2;
        let s=0; for(let i=0;i<n;i++) s += clamp(b[i]+t, lo[i], hi[i]);
        if (s<need) L=t; else R=t;
      }
      const t=(L+R)/2;
      return b.map((bi,i)=> clamp(bi+t, lo[i], hi[i]));
    }

    function allocEven(need, n, minScore, maxScore){
      const lo=Array(n).fill(minScore), hi=Array(n).fill(maxScore);
      const b =Array(n).fill((minScore+maxScore)/2);
      const v=projectToBoxSum(b,lo,hi,need);
      if(!v) return {feasible:false, reason:'Ph√¢n b·ªï ƒë·ªÅu v∆∞·ª£t gi·ªõi h·∫°n'};
      return {feasible:true, values:v};
    }

    function baselineBySubject(scores){
      return [0,1,2].map(s=>{
        const a=scores[s*3+0], b=scores[s*3+1];
        if (!isNaN(a)&&!isNaN(b)) return (a+b)/2;
        if (!isNaN(a)) return a;
        if (!isNaN(b)) return b;
        return 8.0;
      });
    }

    function allocHistory(scores, unknowns, need, minScore, maxScore){
      const n=unknowns.length;
      const lo=Array(n).fill(minScore), hi=Array(n).fill(maxScore);
      const baseBySub=baselineBySubject(scores);
      const b=unknowns.map(idx=>clamp(baseBySub[Math.floor(idx/3)],minScore,maxScore));
      const v=projectToBoxSum(b,lo,hi,need);
      if(!v) return {feasible:false, reason:'Kh√¥ng th·ªÉ ph√¢n theo nƒÉng l·ª±c trong gi·ªõi h·∫°n'};
      return {feasible:true, values:v};
    }

    // Minimax (‚àû-norm) chu·∫©n: t√¨m r nh·ªè nh·∫•t sao cho t·ªìn t·∫°i x v·ªõi |x-b|‚àû ‚â§ r, x‚àà[min,max], sum x = need
    function isFeasibleRadius(b, minA, maxA, need, r){
      const n=b.length;
      let loSum=0, hiSum=0;
      for(let i=0;i<n;i++){
        const lo = Math.max(minA[i], b[i]-r);
        const hi = Math.min(maxA[i], b[i]+r);
        if (lo>hi+1e-9) return false;
        loSum += lo; hiSum += hi;
      }
      return (need>=loSum-1e-6 && need<=hiSum+1e-6);
    }
    function solveMinimax(b, minA, maxA, need){
      let L=0, R=10; // r trong [0,10]
      for(let it=0; it<60; it++){
        const mid=(L+R)/2;
        if (isFeasibleRadius(b,minA,maxA,need,mid)) R=mid; else L=mid;
      }
      const r=(L+R)/2;
      const lo = b.map((bi,i)=> Math.max(minA[i], bi-r));
      const hi = b.map((bi,i)=> Math.min(maxA[i], bi+r));
      return projectToBoxSum(b, lo, hi, need);
    }
    function allocMinimax(scores, unknowns, need, minScore, maxScore){
      const n=unknowns.length;
      const minA=Array(n).fill(minScore), maxA=Array(n).fill(maxScore);
      const baseBySub=baselineBySubject(scores);
      const b=unknowns.map(idx=>clamp(baseBySub[Math.floor(idx/3)],minScore,maxScore));
      const v=solveMinimax(b, minA, maxA, need);
      if(!v) return {feasible:false, reason:'Minimax kh√¥ng kh·∫£ thi v·ªõi gi·ªõi h·∫°n'};
      return {feasible:true, values:v};
    }

    function distributeScores(scores, unknowns, targetAcademic, strategy, minScore, maxScore){
      const res=[...scores];
      if (unknowns.length===0) unknowns = [2,5,8]; // m·∫∑c ƒë·ªãnh ∆∞·ªõc l∆∞·ª£ng l·ªõp 12
      const currentSum = calculateCurrentAcademicSum(scores, unknowns);
      const requiredSum = targetAcademic * 3;
      const need = requiredSum - currentSum;

      const loTotal = unknowns.length*minScore, hiTotal = unknowns.length*maxScore;
      if (need<loTotal-1e-6 || need>hiTotal+1e-6) return {feasible:false, reason:'Kh√¥ng th·ªÉ ph√¢n b·ªï trong gi·ªõi h·∫°n min/max'};

      let out;
      if (strategy==='history') out=allocHistory(scores,unknowns,need,minScore,maxScore);
      else if (strategy==='minimax') out=allocMinimax(scores,unknowns,need,minScore,maxScore);
      else out=allocEven(need,unknowns.length,minScore,maxScore);

      if (!out.feasible) return out;
      unknowns.forEach((pos,i)=>{res[pos]=round2(out.values[i])});
      return {feasible:true, scores:res};
    }

    function solveEstimation(config){
      const {target,targetType,strategy,minScore,maxScore,currentScores,bonusConfig}=config;
      const scores=[...currentScores];
      let unknowns=[];
      for(let i=0;i<9;i++){
        if(scores[i]===null || scores[i]===undefined || isNaN(scores[i])){ unknowns.push(i); scores[i]=0; }
      }
      if (unknowns.length===0) unknowns = [2,5,8]; // ∆∞·ªõc l∆∞·ª£ng l·ªõp 12 m·∫∑c ƒë·ªãnh

      let targetAcademic;
      if (targetType==='academic'){
        targetAcademic = clamp(target, 0, 30);
      } else {
        targetAcademic = solveAcademicFromTotal(target, bonusConfig);
        if (targetAcademic===null) return {feasible:false, reason:'Kh√¥ng th·ªÉ ƒë·∫°t m·ª•c ti√™u v·ªõi ∆∞u ti√™n hi·ªán t·∫°i'};
      }

      // bi√™n kh·∫£ dƒ©
      const maxPossible = (()=>{const t=[...scores]; unknowns.forEach(i=>t[i]=maxScore);
        const av=[avg3(t[0],t[1],t[2]),avg3(t[3],t[4],t[5]),avg3(t[6],t[7],t[8])]; return round2(av[0]+av[1]+av[2]);})();
      const minPossible = (()=>{const t=[...scores]; unknowns.forEach(i=>t[i]=minScore);
        const av=[avg3(t[0],t[1],t[2]),avg3(t[3],t[4],t[5]),avg3(t[6],t[7],t[8])]; return round2(av[0]+av[1]+av[2]);})();
      if (targetAcademic>maxPossible+1e-6 || targetAcademic<minPossible-1e-6){
        return {feasible:false, reason:'M·ª•c ti√™u ngo√†i kh·∫£ nƒÉng', maxAchievable:maxPossible, minAchievable:minPossible};
      }

      const solution = distributeScores(scores, unknowns, targetAcademic, strategy, minScore, maxScore);
      if (!solution.feasible) return solution;

      const final = [...solution.scores];
      const subjectAvgs = [
        avg3(final[0],final[1],final[2]),
        avg3(final[3],final[4],final[5]),
        avg3(final[6],final[7],final[8])
      ];
      const academicTotal = round2(subjectAvgs[0]+subjectAvgs[1]+subjectAvgs[2]);
      const priorityScore = calcPriority(academicTotal, bonusConfig.baseBonus, bonusConfig.mode, bonusConfig.options);
      const finalTotal = round2(academicTotal + priorityScore);

      return {feasible:true, scores:final, unknowns, subjectAvgs, academicTotal, priorityScore, finalTotal, targetAcademic, strategy};
    }

    function runEstimation(){
      const currentScores = [
        ...elements.m1.map(i=>parseFloat(i.value)||null),
        ...elements.m2.map(i=>parseFloat(i.value)||null),
        ...elements.m3.map(i=>parseFloat(i.value)||null)
      ];
      const area=parseFloat(elements.areaBonus.value)||0;
      const cat =parseFloat(elements.categoryBonus.value)||0;
      let ach=0;
      const checks=document.querySelectorAll('.achievement-checkbox:checked');
      if (elements.allowMultiple.checked){checks.forEach(cb=>ach += parseFloat(cb.dataset.base)||0)}
      else{let m=0;checks.forEach(cb=>{const v=parseFloat(cb.dataset.base)||0;if(v>m)m=v});ach=m}
      const baseBonus = round2(area+cat+round2(ach));

      const bonusConfig = {
        baseBonus,
        mode: elements.priorityMode.value,
        options:{threshold:parseFloat(elements.customThreshold.value)||28, denom:parseFloat(elements.customDenom.value)||2}
      };

      const config = {
        target:parseFloat(elements.targetScore.value)||24,
        targetType:elements.targetType.value,
        strategy:elements.strategy.value,
        minScore:parseFloat(elements.minScore.value)||0,
        maxScore:parseFloat(elements.maxScore.value)||10,
        currentScores,
        bonusConfig
      };

      const sol = solveEstimation(config);
      displayEstimationResults(sol);
      saveEstimationState();
    }

    function displayEstimationResults(sol) {
    if (!sol.feasible) {
        elements.estimationResult.classList.add('hidden');
        elements.estimationError.classList.remove('hidden');

        // N·∫øu solver c√≥ tr·∫£ c·∫£ min/max th√¨ ch·ªçn th√¥ng ƒëi·ªáp ph√π h·ª£p
        const hasMin = sol.minAchievable !== undefined;
        const hasMax = sol.maxAchievable !== undefined;

        if (hasMin && hasMax) {
        // Khi m·ª•c ti√™u n·∫±m ngo√†i [min, max]
        // L·∫•y m·ª•c ti√™u ng∆∞·ªùi d√πng (ƒë·ªÉ so s√°nh)
        const G = parseFloat(elements.targetScore.value) || 0;
        const isTotal = elements.targetType.value === 'total';

        // ƒê·ªïi m·ª•c ti√™u v·ªÅ h·ªçc b·∫° n·∫øu l√† "t·ªïng cu·ªëi", ƒë·ªÉ so v·ªõi min/max (ƒë·ªÅu ƒëang l√† h·ªçc b·∫°)
        // N·∫øu b·∫°n kh√¥ng mu·ªën ƒë·ªïi, b·∫°n c√≥ th·ªÉ ch·ªâ so s√°nh th√¥ng ƒëi·ªáp theo c·ªù solver tr·∫£ v·ªÅ.
        let GA = G;
        if (isTotal && sol.targetAcademic !== undefined) {
            GA = sol.targetAcademic; // solver ƒë√£ t√≠nh s·∫µn T c·∫ßn cho F=G
        }

        if (GA < sol.minAchievable - 1e-6) {
            elements.errorMessage.innerHTML =
            `M·ª•c ti√™u <b>qu√° th·∫•p</b>. M·ª•c ti√™u <u>nh·ªè nh·∫•t</u> c√≥ th·ªÉ ƒë·∫°t: <b>${sol.minAchievable.toFixed(2)}</b>`;
        } else if (GA > sol.maxAchievable + 1e-6) {
            elements.errorMessage.innerHTML =
            `M·ª•c ti√™u <b>qu√° cao</b>. M·ª•c ti√™u <u>t·ªëi ƒëa</u> c√≥ th·ªÉ ƒë·∫°t: <b>${sol.maxAchievable.toFixed(2)}</b>`;
        } else {
            elements.errorMessage.textContent = sol.reason || 'Kh√¥ng kh·∫£ thi';
        }
        } else if (hasMax) {
        elements.errorMessage.innerHTML =
            `M·ª•c ti√™u <u>t·ªëi ƒëa</u> c√≥ th·ªÉ ƒë·∫°t: <b>${sol.maxAchievable.toFixed(2)}</b>`;
        } else if (hasMin) {
        elements.errorMessage.innerHTML =
            `M·ª•c ti√™u <u>nh·ªè nh·∫•t</u> c√≥ th·ªÉ ƒë·∫°t: <b>${sol.minAchievable.toFixed(2)}</b>`;
        } else {
        elements.errorMessage.textContent = sol.reason || 'Kh√¥ng kh·∫£ thi';
        }
        return;
    }
      elements.estimationError.classList.add('hidden');
      elements.estimationResult.classList.remove('hidden');

      elements.estAcademic.textContent = sol.academicTotal.toFixed(2);
      elements.estPriority.textContent = sol.priorityScore.toFixed(2);
      elements.estTotal.textContent    = sol.finalTotal.toFixed(2);
      elements.estStatus.textContent   = (sol.finalTotal >= (elements.targetType.value==='academic'? sol.targetAcademic : parseFloat(elements.targetScore.value)||0) - 1e-6)
        ? 'ƒê·∫°t m·ª•c ti√™u' : 'G·∫ßn ƒë·∫°t (tham kh·∫£o)';

      elements.estimationTable.innerHTML = genEstimationTable(sol);
      window.currentEstimationSolution = sol;
    }

    function genEstimationTable(sol){
    const {scores, unknowns, subjectAvgs} = sol;
    const subNames = ['M√¥n 1','M√¥n 2','M√¥n 3'];
    const years    = ['L·ªõp 10','L·ªõp 11','L·ªõp 12'];

    let html = '<div class="text-base md:text-lg font-semibold mb-3 text-blue-300">ƒêi·ªÉm ƒë·ªÅ xu·∫•t:</div>';

    for (let s = 0; s < 3; s++) {
        html += `
        <div class="bg-white/5 rounded-xl p-4 md:p-5 mb-3 md:mb-4 shadow-sm">
            <div class="font-semibold text-${['blue','green','purple'][s]}-300 mb-3 text-lg md:text-xl">
            ${subNames[s]} (TB: ${subjectAvgs[s].toFixed(2)})
            </div>

            <!-- H√†ng ‚ÄúL·ªõp X: 9.50‚Äù to v√† tho√°ng h∆°n -->
            <div class="space-y-2 md:space-y-2.5 text-sm md:text-base leading-6">
        `;

        for (let y = 0; y < 3; y++) {
        const idx = s*3 + y;
        const val = scores[idx];
        const unk = unknowns.includes(idx);

        html += `
            <div class="flex items-center gap-2">
            <span class="text-gray-300 min-w-[70px] md:min-w-[80px]">‚Ä¢ ${years[y]}:</span>
            <span class="${unk ? 'text-yellow-300 font-semibold' : 'text-gray-100'}">
                ${val.toFixed(2)}${unk ? ' *' : ''}
            </span>
            </div>
        `;
        }

        html += `
            </div>
        </div>
        `;
    }

    html += `<div class="text-xs md:text-sm text-yellow-300 mt-2">* ƒêi·ªÉm ƒë∆∞·ª£c ∆∞·ªõc l∆∞·ª£ng</div>`;
    return html;
    }



    function applyEstimation(){
      const sol=window.currentEstimationSolution; if(!sol) return;
      const allInputs=[...elements.m1,...elements.m2,...elements.m3];
      sol.unknowns.forEach(i=>{ if(allInputs[i]) allInputs[i].value = sol.scores[i].toFixed(2) });
      calculate();
      const t=elements.applyEstimation.textContent;
      elements.applyEstimation.textContent='‚úÖ ƒê√£ √°p d·ª•ng!'; elements.applyEstimation.classList.add('bg-blue-500/20','text-blue-300');
      setTimeout(()=>{elements.applyEstimation.textContent=t; elements.applyEstimation.classList.remove('bg-blue-500/20','text-blue-300')},1500);
    }

    function saveEstimationState(){
      const s={targetType:elements.targetType.value,targetScore:elements.targetScore.value,strategy:elements.strategy.value,minScore:elements.minScore.value,maxScore:elements.maxScore.value};
      localStorage.setItem('hocba_estimation_v1', JSON.stringify(s));
    }
    function loadEstimationState(){
      const raw=localStorage.getItem('hocba_estimation_v1'); if(!raw) return;
      try{const s=JSON.parse(raw);
        if(s.targetType) elements.targetType.value=s.targetType;
        if(s.targetScore) elements.targetScore.value=s.targetScore;
        if(s.strategy) elements.strategy.value=s.strategy;
        if(s.minScore) elements.minScore.value=s.minScore;
        if(s.maxScore) elements.maxScore.value=s.maxScore;
      }catch(e){}
    }

    function updateStrategyExplanation(){
      document.getElementById('even-explanation').classList.add('hidden');
      document.getElementById('history-explanation').classList.add('hidden');
      document.getElementById('minimax-explanation').classList.add('hidden');
      const m = elements.strategy.value;
      document.getElementById(`${m}-explanation`).classList.remove('hidden');
    }

    function copyResults(){
      const r = `
üìä K·∫æT QU·∫¢ T√çNH ƒêI·ªÇM H·ªåC B·∫† & ∆ØU TI√äN
‚Ä¢ M√¥n 1: ${elements.avgM1.textContent}
‚Ä¢ M√¥n 2: ${elements.avgM2.textContent}
‚Ä¢ M√¥n 3: ${elements.avgM3.textContent}
T·ªïng h·ªçc b·∫° (30): ${elements.total30.textContent}
Chi ti·∫øt ∆∞u ti√™n: KV ${elements.detailArea.textContent} | ƒêT ${elements.detailCategory.textContent} | TT ${elements.detailAchievement.textContent}
∆Øu ti√™n c∆° s·ªü: ${elements.baseBonus.textContent}
∆Øu ti√™n sau gi·∫£m: ${elements.finalBonus.textContent}
üèÅ T·ªïng cu·ªëi c√πng: ${elements.finalTotal.textContent}`.trim();
      navigator.clipboard.writeText(r).then(()=>{
        const t=elements.copyBtn.textContent; elements.copyBtn.textContent='‚úÖ ƒê√£ copy!'; elements.copyBtn.classList.add('bg-green-500/20','text-green-300');
        setTimeout(()=>{elements.copyBtn.textContent=t; elements.copyBtn.classList.remove('bg-green-500/20','text-green-300')},1500);
      }).catch(()=>alert('Kh√¥ng th·ªÉ copy, vui l√≤ng copy th·ªß c√¥ng.'));
    }

    function setupListeners(){
      [...elements.m1,...elements.m2,...elements.m3, elements.areaBonus, elements.categoryBonus, elements.customThreshold, elements.customDenom]
        .forEach(el=>{ el.addEventListener('input',calculate); el.addEventListener('keypress',e=>{if(e.key==='Enter')calculate()}); });

      elements.priorityMode.addEventListener('change', ()=>{toggleCustomOptions(); calculate()});
      elements.allowMultiple.addEventListener('change', calculate);
      elements.achievementsList.addEventListener('change', e=>{ if(e.target.classList.contains('achievement-checkbox')) calculate() });
      elements.resetBtn.addEventListener('click', resetForm);
      elements.copyBtn.addEventListener('click', copyResults);
      elements.estimateBtn.addEventListener('click', runEstimation);
      elements.applyEstimation.addEventListener('click', applyEstimation);
      elements.strategy.addEventListener('change', updateStrategyExplanation);
    }

    function runTests(){
      console.assert(round2(1.234)===1.23, 'round2');
      console.assert(round2(1.235)===1.24, 'round2');
      console.assert(avg3(8,9,10)===9, 'avg3');
      console.assert(calcPriority(25,1,'MOET')===0.67, 'prio MOET');
      console.assert(calcPriority(20,1,'MOET')===1.00, 'prio below');
      console.assert(calcPriority(29,1,'CUSTOM',{threshold:28,denom:2})===0.50, 'prio custom');
      console.log('‚úÖ basic tests ok');
    }

    function closeCallout(type){
      const box=document.getElementById(`${type}-callout`);
      if (box){ box.style.display='none'; sessionStorage.setItem(`callout_${type}_closed`,'true'); }
    }
    function initCallouts(){
      if (sessionStorage.getItem('callout_countdown_closed')==='true'){
        const x=document.getElementById('countdown-callout'); if (x) x.style.display='none';
      }
    }

    function init(){
      initAchievements();
      initCallouts();
      setupListeners();
      loadState();
      loadEstimationState();
      updateStrategyExplanation();
      toggleCustomOptions();
      calculate();
      runTests();
    }

    (document.readyState==='loading') ? document.addEventListener('DOMContentLoaded', init) : init();
  </script>
</body>
</html>
